# Task Breakdown: Governed AI-Native IDE Extension

## Generated by `/speckit.tasks` ‚Äî 2026-02-20

## Governing Spec: SPEC-003 (ARCHITECTURE_NOTES.md)

---

## Status Legend

| Symbol | Meaning                                      |
| ------ | -------------------------------------------- |
| ‚úÖ     | Complete ‚Äî implemented, tested, verified     |
| üîß     | Partial ‚Äî foundation exists, needs extension |
| ‚¨ú     | Not started ‚Äî new implementation required    |

---

## Phase 0: Archaeological Dig (Research)

**Goal**: Understand existing codebase structure, locate extension points, map the tool execution loop.

| task_id | intent_id | status | description                                                                                | acceptance_criteria                                                                                                                                                    | hook_phase | speckit_command       | depends_on |
| ------- | --------- | ------ | ------------------------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------- | --------------------- | ---------- |
| TSK-001 | INT-001   | ‚úÖ     | Fork Roo Code, run in Extension Host, document `extension.ts` entry point                  | Extension loads and activates in dev Extension Host; entry point documented                                                                                            | DataModel  | /speckit.constitution | ‚Äî          |
| TSK-002 | INT-001   | ‚úÖ     | Trace `execute_command` and `write_to_file` functions, map tool execution loop             | `BaseTool.handle()` ‚Üí `execute()` flow documented; all tool names cataloged in `WRITE_TOOLS` and `EXEMPT_TOOLS` sets                                                   | PreToolUse | /speckit.specify      | TSK-001    |
| TSK-003 | INT-001   | ‚úÖ     | Locate System Prompt builder, document modification points for intent enforcement          | `select_active_intent` tool definition located at `src/core/prompts/tools/native-tools/select_active_intent.ts`; prompt injection via `formatContextForPrompt()` XML   | PreToolUse | /speckit.specify      | TSK-001    |
| TSK-004 | INT-001   | ‚úÖ     | Document existing tool registry, identify extension points for `select_active_intent` tool | Tool schema registered as OpenAI function call in `select_active_intent.ts`; `SelectActiveIntentTool` extends `BaseTool`; tool wired into `presentAssistantMessage.ts` | DataModel  | /speckit.specify      | TSK-001    |

---

## Phase 1: The Handshake (Intent Selection + Reasoning Loop)

**Goal**: Agent declares intent before coding. Context is injected. Write gate is armed.

| task_id | intent_id | status | description                                                                            | acceptance_criteria                                                                                                                                                                                                           | hook_phase | speckit_command    | depends_on |
| ------- | --------- | ------ | -------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------- | ------------------ | ---------- |
| TSK-010 | INT-001   | ‚úÖ     | Define `select_active_intent(intent_id, reasoning?)` tool schema                       | OpenAI function call schema at `src/core/prompts/tools/native-tools/select_active_intent.ts` with `intent_id` (required) and `reasoning` (optional) parameters                                                                | DataModel  | /speckit.specify   | TSK-004    |
| TSK-011 | INT-001   | ‚úÖ     | Implement IntentLoader: parse `active_intents.yaml`, validate intent existence         | `IntentContextLoader` parses YAML, caches with 5s TTL, validates via `IntentValidator`, filters invalid intents with warnings; 8 unit tests passing                                                                           | PreToolUse | /speckit.implement | TSK-010    |
| TSK-012 | INT-001   | ‚úÖ     | Build `<intent_context>` XML generator: constraints + scope only, no full-file dumping | `formatContextForPrompt()` generates XML with scope patterns, constraints, acceptance criteria, related files, and spec excerpts; respects 16KB budget with 3-tier truncation                                                 | PreToolUse | /speckit.implement | TSK-011    |
| TSK-013 | INT-001   | ‚úÖ     | Modify System Prompt: enforce "MUST call select_active_intent before code generation"  | `getGovernanceSection()` in `governance.ts` injects INTENT-DRIVEN GOVERNANCE preamble into system prompt when `.orchestration/active_intents.yaml` exists; integrated into `generatePrompt()` via `Promise.all`; 4 unit tests | PreToolUse | /speckit.implement | TSK-012    |
| TSK-014 | INT-001   | ‚úÖ     | Implement Pre-Hook gatekeeper: block write tools if `activeIntentId` not set           | `HookEngine.preToolUse()` step 2 rejects write tools without active intent; returns actionable error message; `BaseTool.handle()` returns `toolError` on rejection; 19 HookEngine tests                                       | PreToolUse | /speckit.implement | TSK-011    |

---

## Phase 2: Hook Middleware & Security

**Goal**: Full PreToolUse/PostToolUse chain enforcing scope, status, and authorization.

| task_id | intent_id | status | description                                                                               | acceptance_criteria                                                                                                                                                                                                                                                  | hook_phase | speckit_command    | depends_on |
| ------- | --------- | ------ | ----------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------- | ------------------ | ---------- |
| TSK-020 | INT-001   | ‚úÖ     | Classify all existing tools: Safe (EXEMPT) vs Destructive (WRITE), document in `types.ts` | `WRITE_TOOLS` (8 tools) and `EXEMPT_TOOLS` (17 tools) defined as `ReadonlySet<string>` in `types.ts`; unclassified tools (e.g., `execute_command`) pass through with logging                                                                                         | PreToolUse | /speckit.implement | TSK-014    |
| TSK-021 | INT-001   | ‚úÖ     | Implement HITL authorization: `vscode.window.showWarningMessage` for destructive commands | `HITLGate` class with `isDestructive()` check for `execute_command`/`delete_file`; `requestApproval()` shows modal VS Code warning dialog; integrated into HookEngine preToolUse step 5; `setEnabled(false)` for testing; 5 unit tests                               | PreToolUse | /speckit.implement | TSK-020    |
| TSK-022 | INT-001   | ‚úÖ     | Build ScopeMatcher: glob pattern matching for `owned_scope` enforcement                   | Custom `globToRegExp()` and `isInScope()` in `utils.ts` supporting `**` and `*` patterns; no external dependencies; 8 test cases covering exact paths, deep nesting, dotfiles, backslash normalization                                                               | PreToolUse | /speckit.implement | TSK-014    |
| TSK-023 | INT-001   | ‚úÖ     | Implement standardized error protocol: structured `HookResult` for LLM self-correction    | `HookResult` interface with `allowed`, `reason`, `preHash`, `metadata`; rejection messages include actionable guidance (e.g., "Call select_active_intent()", "Amend owned_scope"); `formatResponse.toolError()` used in BaseTool                                     | PreToolUse | /speckit.implement | TSK-014    |
| TSK-024 | INT-001   | ‚úÖ     | Create `.intentignore` parser: exclude patterns from intent enforcement                   | `IntentIgnore` class with `patternToRegExp()` parser supporting `*`, `**`, `?`, comments, trailing slashes; loaded by HookEngine on first enable; `isIgnored()` check in preToolUse returns `{ allowed: true, intentIgnored: true }` for matched paths; 9 unit tests | PreToolUse | /speckit.implement | TSK-022    |

---

## Phase 3: AI-Native Git Layer (Traceability)

**Goal**: Every mutation is hashed, classified, and logged to an append-only audit ledger.

| task_id | intent_id | status | description                                                                     | acceptance_criteria                                                                                                                                                                                                             | hook_phase  | speckit_command    | depends_on |
| ------- | --------- | ------ | ------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------- | ------------------ | ---------- |
| TSK-030 | INT-001   | ‚úÖ     | Implement HashUtils: SHA-256 content hashing for spatial independence           | `computeContentHash()` and `computeFileHash()` in `utils.ts`; returns `sha256:` prefixed hex; null for missing files; 5 test cases including determinism, empty string, Buffer input                                            | PostToolUse | /speckit.implement | TSK-014    |
| TSK-031 | INT-001   | ‚úÖ     | Build mutation classifier: `AST_REFACTOR` vs `INTENT_EVOLUTION` detection logic | `classifyMutation()` in `utils.ts` with 7 `MutationClass` values; classification based on tool name + preHash state; `FILE_CREATION` when preHash is null; 5 test cases                                                         | PostToolUse | /speckit.implement | TSK-030    |
| TSK-032 | INT-001   | ‚úÖ     | Implement TraceSerializer: construct `agent_trace.jsonl` entries per schema     | `TraceLogger.createEntry()` builds `TraceEntry` with UUID v4, ISO 8601 timestamp, all schema fields; 3 test cases (success, no-file, error)                                                                                     | PostToolUse | /speckit.implement | TSK-031    |
| TSK-033 | INT-001   | ‚úÖ     | Build TraceStore: append-only JSONL writer with retry                           | `TraceLogger.log()` appends single JSON line; retries once after 100ms delay; fail-open on double failure; `getRecentEntries()` filters by intent with limit; 7 test cases including retry and malformed lines                  | PostToolUse | /speckit.implement | TSK-032    |
| TSK-034 | INT-001   | ‚úÖ     | Implement IntentMapUpdater: update `intent_map.md` on successful mutations      | `SpatialMapWriter.addFileToIntent()` auto-adds file references; deduplicates; creates section if missing; creates file if missing; `removeFileFromIntent()` for deletions; called from `HookEngine.postToolUse()`; 6 test cases | PostToolUse | /speckit.implement | TSK-033    |

---

## Phase 4: Parallel Orchestration (Master Thinker)

**Goal**: Multiple agents work concurrently with conflict detection and shared learning.

| task_id | intent_id | status | description                                                                                      | acceptance_criteria                                                                                                                                                                                                                                                                                                          | hook_phase  | speckit_command    | depends_on |
| ------- | --------- | ------ | ------------------------------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------- | ------------------ | ---------- |
| TSK-040 | INT-001   | ‚úÖ     | Implement optimistic locking: compute preHash in PreToolUse, log preHash‚ÜípostHash in PostToolUse | PreToolUse step 5 computes SHA-256 preHash; PostToolUse computes postHash; both recorded in trace entry; hash divergence detectable in audit; tested in HookEngine tests                                                                                                                                                     | PreToolUse  | /speckit.implement | TSK-030    |
| TSK-041 | INT-001   | ‚úÖ     | Build "Stale File" error protocol: reject write when preHash doesn't match current file hash     | `fileHashCache` in HookEngine stores last-known hash per file; preToolUse step 6 compares cached hash to re-read hash; returns stale file rejection with truncated hash comparison; records hash mismatch via `LessonRecorder`; postToolUse updates cache after mutation                                                     | PreToolUse  | /speckit.implement | TSK-040    |
| TSK-042 | INT-001   | ‚úÖ     | Implement LessonRecorder: append "Lessons Learned" to `CLAUDE.md` on verification failure        | `LessonRecorder` class with `recordLesson()`, `recordHashMismatch()`, `recordScopeViolation()`; creates Lessons Learned section if missing; inserts before next `## ` section; creates `CLAUDE.md` from scratch if absent; integrated into HookEngine for scope violations, hash mismatches, and tool failures; 6 unit tests | PostToolUse | /speckit.implement | TSK-034    |
| TSK-043 | INT-001   | ‚úÖ     | Build parallel session coordinator: shared `CLAUDE.md` as cross-session memory                   | `SessionCoordinator` class with `heartbeat()` to register/update sessions in `## Active Sessions` markdown table; `listSessions()` parses table; `isIntentClaimedByOther()` detects intent conflicts; `cleanupStaleSessions()` removes entries older than 5 minutes; append-only session registration; 7 unit tests          | DataModel   | /speckit.implement | TSK-042    |

---

## Cross-Cutting Tasks

**Goal**: Shared utilities and developer experience tooling.

| task_id | intent_id | status | description                                                                           | acceptance_criteria                                                                                                                                                                                                                                                                                                                 | hook_phase | speckit_command    | depends_on |
| ------- | --------- | ------ | ------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------- | ------------------ | ---------- |
| TSK-090 | INT-001   | ‚úÖ     | Implement GitUtils wrapper: get current SHA, detect uncommitted changes               | `GitUtils` class with `getCurrentSha()`, `getShortSha()`, `hasUncommittedChanges()`, `isGitRepo()`, `getCurrentBranch()`; uses `child_process.exec` with 5s timeout; all methods return null/false on failure; 7 unit tests                                                                                                         | DataModel  | /speckit.implement | ‚Äî          |
| TSK-091 | INT-001   | ‚úÖ     | Build XML context injector: safely embed `<intent_context>` without breaking prompt   | `formatContextForPrompt()` generates well-formed XML; tested in IntentContextLoader tests; truncation prevents budget overflow; includes scope, constraints, acceptance criteria, related files, spec excerpts                                                                                                                      | PreToolUse | /speckit.implement | TSK-012    |
| TSK-092 | INT-001   | ‚úÖ     | Create demo workspace setup script: generate sample `.orchestration/` for Weather API | `scripts/setup-demo-workspace.sh` generates complete `.orchestration/` with `active_intents.yaml` (2 demo intents: Weather API + Bug Fix), `CLAUDE.md`, `intent_map.md`, empty `agent_trace.jsonl`, `.intentignore` (lockfiles, build artifacts, editor config), and `README.md`; idempotent (aborts if already exists); executable | DataModel  | /speckit.implement | ‚Äî          |

---

## Summary Matrix

### Completion Status

| Phase                           | Total  | ‚úÖ Done | üîß Partial | ‚¨ú Remaining |
| ------------------------------- | ------ | ------- | ---------- | ------------ |
| Phase 0: Archaeological Dig     | 4      | 4       | 0          | 0            |
| Phase 1: The Handshake          | 5      | 5       | 0          | 0            |
| Phase 2: Hook Middleware        | 5      | 5       | 0          | 0            |
| Phase 3: Traceability           | 5      | 5       | 0          | 0            |
| Phase 4: Parallel Orchestration | 4      | 4       | 0          | 0            |
| Cross-Cutting                   | 3      | 3       | 0          | 0            |
| **Total**                       | **26** | **26**  | **0**      | **0**        |

### All Tasks Complete

All 26 tasks implemented, tested, and verified. 161 unit tests passing across 13 test files.

### Dependency Graph (All Resolved)

```
TSK-013 (System Prompt) ‚Üê TSK-012 ‚úÖ
TSK-021 (HITL)          ‚Üê TSK-020 ‚úÖ
TSK-024 (.intentignore)  ‚Üê TSK-022 ‚úÖ
TSK-041 (Stale File)     ‚Üê TSK-040 ‚úÖ
TSK-042 (LessonRecorder) ‚Üê TSK-034 ‚úÖ
TSK-043 (Session Coord)  ‚Üê TSK-042 ‚úÖ
TSK-090 (GitUtils)       ‚Üê none
TSK-092 (Demo Script)    ‚Üê none
```

---

## Speckit Command Traceability

| speckit_command         | Tasks Generated                    | Tasks Validated By           |
| ----------------------- | ---------------------------------- | ---------------------------- |
| `/speckit.constitution` | TSK-001                            | Constitution ratification    |
| `/speckit.specify`      | TSK-002, TSK-003, TSK-004, TSK-010 | SPEC-001, SPEC-002, SPEC-003 |
| `/speckit.plan`         | (informed task ordering)           | PLAN-001, PLAN-002           |
| `/speckit.tasks`        | This document                      | SPEC-003 cross-reference     |
| `/speckit.implement`    | TSK-011 through TSK-092            | Unit tests (161 passing)     |
